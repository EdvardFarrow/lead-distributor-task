[![CRM Test Task CI](https://github.com/EdvardFarrow/lead-distributor-task/actions/workflows/ci.yml/badge.svg)](https://github.com/EdvardFarrow/lead-distributor-task/actions/workflows/ci.yml)

# üéØ CRM Lead Distributor Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ **FastAPI** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –ª–∏–¥–æ–≤ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏.
–†–µ–∞–ª–∏–∑—É–µ—Ç —É–º–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞—è–≤–æ–∫ —Å —É—á–µ—Ç–æ–º **–≤–µ—Å–æ–≤** (–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π) –∏ —Ç–µ–∫—É—â–µ–π **–Ω–∞–≥—Ä—É–∑–∫–∏** –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.

## üöÄ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å—Ç–µ–∫ (`FastAPI`, `SQLAlchemy`, `aiosqlite`) –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ I/O.
* **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL:** –ü–æ–¥—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (Count Open Tickets) –∏ –≤—ã–±–æ—Ä–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∑–∞ **–æ–¥–∏–Ω** SQL-–∑–∞–ø—Ä–æ—Å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LEFT JOIN` –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ë–î).
* **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –û–±—Ä–∞–±–æ—Ç–∫–∞ **Race Conditions** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏–¥–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `flush` –∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç `IntegrityError`).
* **Modern Python:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Python 3.11+, Pydantic v2, lifespan events.
* **CI/CD:** –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø–∞–π–ø–ª–∞–π–Ω GitHub Actions –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤.

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

* **Language:** Python 3.11
* **Framework:** FastAPI
* **Database:** SQLite (Async) via SQLAlchemy 2.0
* **Testing:** Pytest, AsyncClient (httpx), In-memory DB
* **Infra:** Docker, Docker Compose

---

## üß† –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

–õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ (`POST /interactions/`) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

1.  **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –õ–∏–¥–∞:** –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ª–∏–¥–∞ –ø–æ `external_id`. –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç ‚Äî —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–µ–π –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö).
2.  **–ê–Ω–∞–ª–∏–∑ –û–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (Single Query):**
    * –û–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –¥–∞–Ω–Ω–æ–º—É –ò—Å—Ç–æ—á–Ω–∏–∫—É.
    * –ö –∫–∞–∂–¥–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É "–¥–∂–æ–π–Ω–∏—Ç—Å—è" –µ–≥–æ —Ç–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `OPEN`).
3.  **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
    * –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (`is_active=False`).
    * –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö `current_load >= max_load`.
4.  **–í—ã–±–æ—Ä (Weighted Random):**
    * –°—Ä–µ–¥–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä (`random.choices`).
    * –ß–µ–º –≤—ã—à–µ –≤–µ—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞, —Ç–µ–º –≤—ã—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.
5.  **–§–∏–∫—Å–∞—Ü–∏—è:** –°–æ–∑–¥–∞–µ—Ç—Å—è `Interaction`, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.

–ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ—Ç, –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (`operator_id=None`).

---

## üì¶ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –ß–µ—Ä–µ–∑ Docker (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up --build
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8000 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (Swagger): http://localhost:8000/docs

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (–ë–µ–∑ Docker)

```bash
# –°–æ–∑–¥–∞—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å venv
python3 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
uvicorn app.main:app --reload
```
## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è in-memory –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞.

## –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
pytest -v
```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

* app/main.py ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Ä–æ—É—Ç–∏–Ω–≥, lifespan.

* app/services.py ‚Äî –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã.

* app/models.py ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏.

* app/schemas.py ‚Äî Pydantic —Å—Ö–µ–º—ã (–≤–∞–ª–∏–¥–∞—Ü–∏—è).

* app/database.py ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–≤–∏–∂–∫–∞ –ë–î.

* tests/ ‚Äî –¢–µ—Å—Ç—ã API –∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

